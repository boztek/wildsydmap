<!DOCTYPE html>
<html>
<head>
    <title>Wild Sydney Map</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <style type="text/css">
        html {
            height: 100%
        }

        body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #595959;
            color: #DAA520;
            text-transform: uppercase;
            font-family: "arial", "san serif";
            font-size: 16px;


        }

        h4 {
            font-size: 0.8em;
        }

        a.instagram, a.instagram:visited {
            color: #DAA520;
            text-decoration: none;
            /*padding: 1em;*/
            position: absolute;
            top: 1em;
            padding: 0.5em 2em 1em 2em;
            font-size: 0.8em
        }
        a.instagram:hover {
            text-decoration: underline;
        }

        #dialog-modal {
            display: none;
        }

        #map-canvas {
            height: 100%;
            width: 90%;
            float: right;
        }

        .instagram-caption,
        .instagram-comments,
        .instagram-comments-comment {
            width: 320px;
        }

        .instagram-image-std {
            margin-top: 1em;
        }

        .instagram-comments-comment {
            list-style: none;
            font-size: 0.9em;
            margin-bottom: 0.5em;
            display: block;
            text-transform: none;
            clear: both;
        }
        .instagram-comments-comment-profile {
            width: 25px;
            height: 25px;
            margin-right: 1em;
            float: left;
        }

        .instagram-author-info {
            font-size: 0.8em;
        }
        .instagram-date {
        }
    </style>
    <link rel="stylesheet" type="text/css" href="css/jquery-ui.css" />
    <link rel="stylesheet" type="text/css" href="css/jquery.ui.dialog.css" />
    <script src="js/jquery-1.10.2.js"></script>
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBXWYSYuzbLCbBf7ulR43jd4ZgXuycuk4Y&sensor=true">
    </script>
    <script type="text/javascript">
        function initialize() {
            var mapOptions = {
                center: new google.maps.LatLng(-34.397, 150.644),
                zoom: 8,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            var map = new google.maps.Map(document.getElementById("map-canvas"),
                    mapOptions);


            return map;
        }
//        google.maps.event.addDomListener(window, 'load', initialize);

        var instagram_end = 'https://api.instagram.com/v1/tags/wildsydney/media/recent?access_token=';

        jQuery(function () {
            var map = initialize();
            var path = window.location.href || '';
            var access_token = '';
            if (path.split('#').length > 1) {
                access_token = path.split('#')[1].split('=')[1];
            }
            else {
                jQuery( "#dialog-modal" ).dialog({
                    height: 140,
                    modal: true
                });
                return;
            }
            var ig_api = instagram_end + access_token;
            // console.log(ig_api);

            var tag = "wildsydney";
            var count = 4;
            var access_parameters = {access_token: access_token};

            function grabImages(access_parameters) {

                jQuery.ajax({
                    type: "GET",
                    dataType: "jsonp",
                    cache: false,
                    url: ig_api,
                    success: function (data) {

                        // console.log(data);
                        var add_marker = function (id, point, note) {
                            var info_window = new google.maps.InfoWindow({content: ''});

                            function add_marker(racer_id, point, note) {
                                var marker = new google.maps.Marker({map: map, position: point, clickable: true});
                                marker.note = note;
                                google.maps.event.addListener(marker, 'click', function () {
                                    info_window.content = marker.note;
                                    info_window.open(map, marker);
                                });
                                return marker;
                            }
                        }

                        for (var i = 0; i < data.data.length; ++i) {
                            var instagram_data = data.data[i];
                            // console.log(instagram_data);
                            var image = instagram_data.images.thumbnail.url;
                            var full_image = instagram_data.images.standard_resolution.url;
                            var full_name = instagram_data.caption.from.full_name;
                            var created_time = instagram_data.created_time;
                            var created_date = new Date(parseInt(created_time) * 1000);
                            var caption = instagram_data.caption.text;

                            if (data.data[i].location === null) {
                                continue;
                            }
                            var lat = data.data[i].location.latitude;
                            var lon = data.data[i].location.longitude;

                            var myLatlng = new google.maps.LatLng(lat, lon);
                            var icon_size = new google.maps.Size(60, 60);
                            var icon = {
                                scaledSize: icon_size,
                                url: image
                            };
                            var marker = new google.maps.Marker({
                                position: myLatlng,
                                map: map,
                                title: full_name,
                                icon: icon
                            });
                            var comments = [];
                            var comments_data = data.data[i].comments.data;
                            for (var j = 0; j < comments_data.length; j++) {
                                var this_comment = {};
                                this_comment.name = comments_data[j].from.full_name;
                                this_comment.text = comments_data[j].text;
                                this_comment.profile_picture = comments_data[j].from.profile_picture;
                                comments.push(this_comment);
                            }
                            // console.log(comments);
                            var comments_text = '<div class="instagram-comments>"><h4>Comments<h4><ul>';
                            for (var k = 0; k < comments.length; k++) {
                                var comment_text = '<li class="instagram-comments-comment">' +
                                                    '<img class="instagram-comments-comment-profile" src="' +comments[k].profile_picture+ '" />' +
                                                    comments[k].name + ': ' + comments[k].text +
                                                    '</li>'
                                comments_text += comment_text;
                            }
                            comments_text += '</ul></div> <!-- //end instagram-comments -->';
                            
                            var created_date_string = (created_date.getMonth()+1)+"/"+created_date.getDate()+"/"+created_date.getFullYear();
                            marker.info = new google.maps.InfoWindow({
                                content: '<a href="' +instagram_data.link+ '"><img class="instagram-image-std" width=360 src="' +image+ '" /></a>' +
                                         '<div class="instagram-caption">' +caption+ '</div>' +
                                         '<div class="instagram-author-info">Taken by ' +full_name+ ' <span class="instagram-date"> (' +created_date_string+ ')</div></div>'
                            });

                            if (comments.length > 0) {
                                marker.info.content += comments_text;
                            }

                            google.maps.event.addListener(marker, 'click', function () {
                                this.info.open(map, this);
                            });
                        }

                    }
                });
            }

            function onDataLoaded(instagram_data) {

                if (instagram_data.meta.code == 200) {

                    var photos = instagram_data.data;

                    if (photos.length > 0) {

                        for (var key in photos) {
                            var photo = photos[key];
                            $('#target').append('<img src =' + photo.images.thumbnail.url + '">');
                        }
                    } else {

                        $("#target").append("Hmmm. I couldn't find anything!");
                    }
                } else {

                    var error = data.meta.error_message;
                    $("#target").append('Something happened, Instagram said:' + error);

                }

            }


            grabImages(access_parameters);
        });

    </script>
</head>
<body>
    <div id="dialog-modal" title="Connect to Instagram">
        <p>Log in to Instagram using the link provided.</p>
    </div>
    <div class="container">
        <a href="/">
            <img src="img/logo.png">
        </a>
        <a class="instagram" href="https://instagram.com/oauth/authorize/?client_id=2263f091c81742ceb20d2d3ee57197a0&redirect_uri=http://wildsyd.dev:9999&response_type=token">Login to Instagram</a>
    </div>
    <div id="map-canvas" />
</body>
</html>