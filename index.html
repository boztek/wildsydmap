<!DOCTYPE html>
<html>
<head>
    <title>Wild Sydney Map</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <style type="text/css">
        html {
            height: 100%
        }

        body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #595959;
            color: #DAA520;
            text-transform: uppercase;
            font-family: "arial", "san serif";
            font-size: 16px;
        }

        a.instagram, a.instagram:visited {
            color: #DAA520;
            text-decoration: none;
            /*padding: 1em;*/
            position: absolute;
            top: 1em;
            padding: 0.5em 2em 1em 2em;
            font-size: 0.8em
        }
        a.instagram:hover {
            text-decoration: underline;
        }

        #map-canvas {
            height: 100%;
            width: 90%;
            float: right;
        }
    </style>
    <script src="js/jquery-1.10.2.js"></script>
    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBXWYSYuzbLCbBf7ulR43jd4ZgXuycuk4Y&sensor=true">
    </script>
    <script type="text/javascript">
        function initialize() {
            var mapOptions = {
                center: new google.maps.LatLng(-34.397, 150.644),
                zoom: 8,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            var map = new google.maps.Map(document.getElementById("map-canvas"),
                    mapOptions);


            return map;
        }
//        google.maps.event.addDomListener(window, 'load', initialize);

        var instagram_end = 'https://api.instagram.com/v1/tags/wildsydney/media/recent?access_token=';

        jQuery(function () {
            var map = initialize();

            var access_token = window.location.href.split('#')[1].split('=')[1];
            var ig_api = instagram_end + access_token;
            // console.log(ig_api);

            var tag = "wildsydney";
            var count = 4;
            var access_parameters = {access_token: access_token};

            function grabImages(access_parameters) {

                jQuery.ajax({
                    type: "GET",
                    dataType: "jsonp",
                    cache: false,
                    url: ig_api,
                    success: function (data) {

                        // console.log(data);
                        var add_marker = function (id, point, note) {
                            var info_window = new google.maps.InfoWindow({content: ''});

                            function add_marker(racer_id, point, note) {
                                var marker = new google.maps.Marker({map: map, position: point, clickable: true});
                                marker.note = note;
                                google.maps.event.addListener(marker, 'click', function () {
                                    info_window.content = marker.note;
                                    info_window.open(map, marker);
                                });
                                return marker;
                            }
                        }

                        for (var i = 0; i < data.data.length; ++i) {
                            // console.log(data.data[i]);
                            var image = data.data[i].images.thumbnail.url;
                            var full_image = data.data[i].images.standard_resolution.url;
                            var full_name = data.data[i].caption.from.full_name;

                            if (data.data[i].location === null) {
                                continue;
                            }
                            var lat = data.data[i].location.latitude;
                            var lon = data.data[i].location.longitude;

                            var myLatlng = new google.maps.LatLng(lat, lon);
                            var icon_size = new google.maps.Size(50, 50);
                            var icon = {
                                scaledSize: icon_size,
                                url: image
                            };
                            // console.log(image);
                            var marker = new google.maps.Marker({
                                position: myLatlng,
                                map: map,
                                title: full_name,
                                icon: icon
                            });
                            var comments = [];
                            var comments_data = data.data[i].comments.data;
                            for (var j = 0; j < comments_data.length; j++) {
                                var this_comment = {};
                                this_comment.name = comments_data[j].from.full_name;
                                this_comment.text = comments_data[j].text;
                                comments.push(this_comment);
                            }
                            // console.log(comments);
                            var comments_text = '<h4>Comments<h4><ul>';
                            for (var k = 0; k < comments.length; k++) {
                                var comment_text = '<li>' +comments[k].name+ ': ' +comments[k].text+ '</li>'
                                comments_text += comment_text;
                            }
                            comments_text += '</ul>';
                            
                            marker.info = new google.maps.InfoWindow({
                                content: '<h3>' +full_name+ '</h3><img width=300 src="' +image+ '" />' + comments_text,
                            });
                            google.maps.event.addListener(marker, 'click', function () {
                                this.info.open(map, this);
                            });
                        }

                    }
                });
            }

            function onDataLoaded(instagram_data) {

                if (instagram_data.meta.code == 200) {

                    var photos = instagram_data.data;

                    if (photos.length > 0) {

                        for (var key in photos) {
                            var photo = photos[key];
                            $('#target').append('<img src =' + photo.images.thumbnail.url + '">');
                        }
                    } else {

                        $("#target").append("Hmmm. I couldn't find anything!");
                    }
                } else {

                    var error = data.meta.error_message;
                    $("#target").append('Something happened, Instagram said:' + error);

                }

            }


            grabImages(access_parameters);
        });

    </script>
</head>
<body>
    <div class="container">
        <a href="/">
            <img src="img/logo.png">
        </a>
        <a class="instagram" href="https://instagram.com/oauth/authorize/?client_id=2263f091c81742ceb20d2d3ee57197a0&redirect_uri=http://wildsyd.dev:9999&response_type=token">Login to Instagram</a>
    </div>
    <div id="map-canvas" />
</body>
</html>