<!DOCTYPE html>
<html>
<head>
    <title>Wild Sydney Map</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <style type="text/css">
        html {
            height: 100%
        }

        body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #333333;
            color: #ffcc66;
            text-transform: uppercase;
            font-family: "Lucida Grande", "arial", "san serif";
            font-size: 16px;
        }

        h4 {
            font-size: 0.8em;
        }
        h4.comments {
            color: #333333;
            font-weight: bold;
        }

        ul {
            padding-left: 2em;
        }

        .logo {
            /*float: left;*/
            width: 100px;
        }

        .login {
            display: block;
            width: 40%;
            float: left;
            margin-top: 2em;
        }
        a, a.instagram, a.instagram:visited {
            color: #ffcc66;
            text-decoration: none;
            padding: 0.5em 2em 1em 2em;
            font-size: 0.8em
            display: block;
        }
        a.instagram:hover {
            text-decoration: underline;
        }

        .info {
            font-size: 0.7em;
            margin: 1em auto 1em auto;
            padding: 0.5em 2em 1em 2em;
            cursor: pointer; cursor: hand;
        }

        .login {
            position: absolute;
            bottom: 4em;
            font-size: 0.7em;
            margin: 3em auto 1em auto;
        }

        #dialog-modal, #dialog-confirm {
            display: none;

            font-size: 0.7em;
            width: 480px;
            height: 480px;
        }
        .ui-dialog {
            width: 640px !important;
        }
        #about {
            display: none;
            font-size: 0.7em;
            text-transform: none;
        }

        .container-header {
            height: 10%;
            width: 100%;
            position: relative;
        }
        .container-sidebar {
            width: 10%;
            min-width: 50px;
            float: left;
        }
        #map-canvas {
            height: 90%;
            width: 90%;
            float: right;
        }

        .instagram-caption,
        .instagram-comments,
        .instagram-comments-comment {
            width: 320px;
            color: #333333;
        }

        .instagram-image-std {
            margin-top: 1em;
        }

        .instagram-comments-comment {
            list-style: none;
            font-size: 1em;
            margin-bottom: 1em;
            display: block;
            text-transform: none;
            clear: both;
            color: #333333;

        }
        .instagram-comments-comment-profile {
            width: 50px;
            height: 50px;
            margin-right: 1em;
            float: left;
            color: #333333;

        }

        .instagram-author-info {
            font-size: 0.8em;
            color: #333333;

        }
        .instagram-date {
            color: #333333;

        }

        .cf:before,
        .cf:after {
            content: " "; /* 1 */
            display: table; /* 2 */
        }

        .cf:after {
            clear: both;
        }

        #tag-search {
            width: 50%;
            height: 100%;
            position: absolute;
            /*border: 1px solid red;*/
            top: 1em;
            right: 0;
        }
        #tag-search input {
            border:0; 
            padding:10px; 
            font-size:1.3em; 
            font-family:Arial, sans-serif; 
            color:#aaa; 
            border:solid 1px #ccc; 
            /*margin:0 0 20px; */
            width:300px;
            -webkit-border-radius: 6px;
            -moz-border-radius: 6px;
            border-radius: 6px;
            color: #4e6f59;
        }
        #tag-search input[type=textfield] {
            margin-right: 8em;
            -moz-box-shadow: inset 0 0 4px rgba(0,0,0,0.2); 
            -webkit-box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.2); 
            box-shadow: inner 0 0 4px rgba(0, 0, 0, 0.2);
            position: absolute;
            right: 0;
            /*top: 0.5em;*/
        }

        #tag-search input[type=submit] {
            position: absolute;
            right: 1em;
            width: 6em;
            /*top: 0.5em;*/
        }

        #tag-search-spin {
            /*width: 80px;*/
            float: right;
            padding-top: 3em;
            margin-right: 33em;
        }
    </style>
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
    <link rel="stylesheet" type="text/css" href="css/jquery-ui.css" />
    <link rel="stylesheet" type="text/css" href="css/jquery.ui.dialog.css" />
</head>
<body>
    <div id="dialog-confirm" title="Connect to Instagram">
  <p><span class="ui-icon ui-icon-alert" style="float: left; margin: 0 7px 20px 0;"></span>Connect to Instagram to see latest #wildsydney finds.</p>
</div>

    <div id="about" title="About">
        <h2>About<h2>
        <p>The #WildSydney food map is a user generated initiative, mapping the
        free food and medicine plants (both native and non native) living in the
        Sydney basin. Following many years of experience providing workshops
        and tours educating the public on the useful weeds to be found and
        foraged in the urban landscape, Naturalist Diego Bonetto in collaboration
        with producer Adrian O'Doherty have created a reliable and extended
        map 'harvesting' photographs from instagram to provide a platform for
        sharing location and seasonal information. The development of the
        Instagram and Google map API mashup was made possible thanks to Boris Gordon.</p>

        <p>Responding to ever-growing interest of the catering industry, gardeners, 
        alternative medicine practitioners and sustainability advocates,
        #WildSydney will provide an online resource where people can engage 
        by positively identifying a variety of plant species, learn about the plants 
        uses and locate safe and clean gathering locations.</p>

        <p>Why? We believe Dandelions make the best coffee, but do we know where 
        to collect them from the wild? #wildsydney will facilitate this exchange of 
        information, fostering connections, knowledge and appreciation of the 
        wild resources around us all, with a few good recipes in the mix.</p>

        <p>We hope you enjoy the evolution of this project and welcome your 
        contributions, for futher information and enquiries;
        Please visit: www.weedyconnection.com or contact info@weedyconnection.comp</p>
        </p>
    </div>
    <div class="container container-header">
        <a href="/">
            <img class="logo" src="img/logo.svg">
        </a>

        <div id="tag-search">
            <div id="tag-search-spin"></div>
            <form>
                <input type="textfield" name="tag-search" placeholder="Search for a tag ..." />
                <input type="submit" value="Search" />
            </form>
        </div>
    </div>
    <div class="container container-sidebar">
        <div class="info info-about">About</div>
        <div class="login">
            <a class="instagram" href="/">Logout</a>
        </div>
    </div>
    <div id="map-canvas" />
    <script src="js/ig-access.js"></script>
    <script src="js/jquery-1.10.2.js"></script>
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <script src="js/spin.min.js"></script>
    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBXWYSYuzbLCbBf7ulR43jd4ZgXuycuk4Y&sensor=true">
    </script>
    <script type="text/javascript">
        function initialize() {
            // 33.8903° S, 151.1966° E
            var mapOptions = {
                center: new google.maps.LatLng(-33.8903, 151.1966),
                zoom: 15,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            var map = new google.maps.Map(document.getElementById("map-canvas"),
                    mapOptions);


            return map;
        }

        var instagram_end_raw     = 'https://api.instagram.com/v1/';
        var instagram_end_default = 'https://api.instagram.com/v1/tags/wildsydney/media/recent?access_token=';

        jQuery(function () {
            var map = initialize();
            var markers = [];
            var infowindow = new google.maps.InfoWindow();
            var rendering_data = [];
            var path = window.location.href || '';
            var access_token = '';

            var spin_opts = {
              lines: 9, // The number of lines to draw
              length: 10, // The length of each line
              width: 5, // The line thickness
              radius: 5, // The radius of the inner circle
              corners: 1, // Corner roundness (0..1)
              rotate: 0, // The rotation offset
              direction: 1, // 1: clockwise, -1: counterclockwise
              color: '#000', // #rgb or #rrggbb
              speed: 1, // Rounds per second
              trail: 60, // Afterglow percentage
              shadow: false, // Whether to render a shadow
              hwaccel: false, // Whether to use hardware acceleration
              className: 'spinner', // The CSS class to assign to the spinner
              zIndex: 2e9, // The z-index (defaults to 2000000000)
              top: 'auto', // Top position relative to parent in px
              left: 'auto' // Left position relative to parent in px
            };
            var tag_search_target = document.getElementById('tag-search-spin');
            var spinner = new Spinner(spin_opts);

            if (path.split('#').length > 1) {
                access_token = path.split('#')[1].split('=')[1];
            }
            else {
                jQuery(function() {
                    ig_auth = 'https://instagram.com/oauth/authorize/?client_id=' +window.Wildsyd.client_id+ '&redirect_uri=' +window.Wildsyd.redirect_uri+ '&response_type=token'
                    jQuery( "#dialog-confirm" ).dialog({
                      resizable: false,
                      height:140,
                      modal: true,
                      buttons: {
                        "Connect": function() {
                            window.location.href = ig_auth;
                        },
                        Cancel: function() {
                          $( this ).dialog( "close" );
                        }
                      }
                    });
                  });
                return;
            }

            function renderMarkers(data) {
                for (var i = 0; i < data.length; ++i) {
                    var instagram_data = data[i];
                    // console.log(instagram_data);
                    var image        = instagram_data.images.standard_resolution.url;
                    var full_image   = instagram_data.images.standard_resolution.url;
                    var full_name    = (instagram_data.caption && instagram_data.caption.from.full_name) || '';
                    var created_time = instagram_data.created_time;
                    var created_date = new Date(parseInt(created_time) * 1000);
                    var caption = (instagram_data.caption && instagram_data.caption.text) || '';

                    if (data[i].location === null) {
                        continue;
                    }
                    var lat = data[i].location.latitude;
                    var lon = data[i].location.longitude;

                    var myLatlng = new google.maps.LatLng(lat, lon);
                    var icon_size = new google.maps.Size(32, 32);
                    var icon = {
                        scaledSize: icon_size,
                        url: image
                    };
                    var marker = new google.maps.Marker({
                        position: myLatlng,
                        map: map,
                        title: full_name,
                        icon: icon
                    });
                    markers.push(marker);
                    var comments = [];
                    var comments_data = data[i].comments.data;
                    for (var j = 0; j < comments_data.length; j++) {
                        var this_comment = {};
                        this_comment.name = comments_data[j].from.full_name;
                        this_comment.text = comments_data[j].text;
                        this_comment.profile_picture = comments_data[j].from.profile_picture;
                        comments.push(this_comment);
                    }
                    // console.log(comments);
                    var comments_text = '<div class="instagram-comments>"><h4 class="comments">Comments<h4><ul>';
                    for (var k = 0; k < comments.length; k++) {
                        var comment_text = '<li class="instagram-comments-comment cf">' +
                                            '<img class="instagram-comments-comment-profile" src="' +comments[k].profile_picture+ '" />' +
                                            comments[k].name + ': ' + comments[k].text +
                                            '</li>'
                        comments_text += comment_text;
                    }
                    comments_text += '</ul></div> <!-- //end instagram-comments -->';

                    var created_date_string = (created_date.getMonth()+1)+"/"+created_date.getDate()+"/"+created_date.getFullYear();

                    // save info content for this marker
                    // info_content[i] = '<a href="' +instagram_data.link+ '" target="_blank"><img class="instagram-image-std" width=360 src="' +full_image+ '" /></a>' +
                    //              '<div class="instagram-caption">' +caption+ '</div>' +
                    //              '<div class="instagram-author-info">Taken by ' +full_name+ ' <span class="instagram-date"> (' +created_date_string+ ')</div></div>';

                    marker.info = new google.maps.InfoWindow({
                        content: '<a href="' +instagram_data.link+ '" target="_blank"><img class="instagram-image-std" width=360 src="' +full_image+ '" /></a>' +
                                 '<div class="instagram-caption">' +caption+ '</div>' +
                                 '<div class="instagram-author-info">Taken by ' +full_name+ ' <span class="instagram-date"> (' +created_date_string+ ')</div></div>'
                    });

                    if (comments.length > 0) {
                        // info_content[i] += comments_text;
                        marker.info.content += comments_text;
                    }

                    google.maps.event.addListener(marker, 'click', function () {
                        if (infowindow) {
                            infowindow.close();
                        }
                        this.info.open(map, this);
                        infowindow = this.info;
                    });
                }
            }

            function createImageGrabber(api) {

                return function () {

                    jQuery.ajax({
                        type: "GET",
                        dataType: "jsonp",
                        cache: false,
                        url: api,
                        success: function (data) {
                            // console.log(data);
                            if (spinner && !spinner.el) {
                                spinner.spin(tag_search_target);                                
                            }
                            var next_page = data.pagination.next_url || '';
                            var grabNextImages = createImageGrabber(next_page);
                            if (!next_page) {
                                // console.log('last page reached');
                                if (data.data) {
                                    renderMarkers(data.data);
                                }
                                if (spinner) {
                                    spinner.stop();
                                }
                            }
                            else {
                                renderMarkers(data.data);
                                grabNextImages(next_page);
                            }
                        }
                    });
                }
            }

            var ig_api = instagram_end_default + access_token;
            var grabImages = createImageGrabber(ig_api);
            grabImages();

            $('#tag-search').submit(function (e) {
                var tag = $('#tag-search input[type=textfield]').val() || 'wildsydney';
                var instagram_tag_search_api = instagram_end_raw + 'tags/' +tag+ '/media/recent?access_token=' + access_token;
                for (var z = 0; z < markers.length; z++) {
                    markers[z].setMap(null);
                }
                var grabSearchResults = createImageGrabber(instagram_tag_search_api);
                grabSearchResults();

                return false;
            });

            $('.info-about').click(function (e) {
                $( "#about" ).dialog({
                      modal: true,
                      height: 480,
                      buttons: {
                        Ok: function() {
                          $( this ).dialog( "close" );
                        }
                      }
                });
                return false;
            });
        });
    </script>
</body>
</html>